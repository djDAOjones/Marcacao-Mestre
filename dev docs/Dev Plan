# MarcaÃ§Ã£o Mestre â€” Development Plan v2

## Overview
Build a PWA beat-matched grid player for Capoeira classes per Spec v4.

## Phases

### Phase 1: Core Playback (MVP)
- [x] Project setup (Vite + React + TypeScript + Tailwind)
- [x] ZIP upload + manifest parsing
- [x] MIDI tempo track parser
- [x] IndexedDB storage layer (Dexie.js)
- [x] Basic grid UI with button states
- [x] Single-track playback (no transitions)
- [x] Duck control

**Deliverable:** User can upload ZIP, see grid, tap to play one track at a time.

---

### Phase 2: Transitions
- [x] SoundTouchJS integration for time-stretching
- [x] Beat scheduler (downbeat detection)
- [x] Quantise ON mode (locked BPM transitions)
- [x] Equal-power crossfade
- [x] Transport status display (NOW/NEXT/STATUS)
- [x] Dual-deck engine architecture

**Deliverable:** Beat-matched crossfades at locked BPM.

---

### Phase 3: Tempo Slide
- [x] Quantise OFF mode (tempo slide algorithm)
- [x] Dual-deck synchronised tempo ramping
- [ ] Polish transition smoothness

**Deliverable:** Smooth tempo-sliding transitions.

---

### Phase 4: UX Polish (Spec v4 Simplification)
- [x] Fix: Audible crossfade not working (CHG-03) â€” fixed isPlaying condition
- [x] Track click behaviour:
  - [x] Single click: add to end of queue
  - [x] Double click: insert as next track
  - [x] Triple click: mix immediately
- [x] Multi-track queue with per-track mix settings
- [x] Drag-and-drop upload
- [x] **Simplified Controls (v4):**
  - [x] Replace Quantise + Mix Length with single MIX/CUT toggle
    - MIX = 2-bar quantised crossfade with tempo slide
    - CUT = bar-aligned instant switch with beat sync
  - [x] NEXT button to trigger queued track transition immediately
  - [x] Global Pause with fade effects:
    - Pause: 0.5s fade-down
    - Resume: rewind 1s, then 0.5s fade-up
- [x] **CUT mode enhancement:**
  - [x] Wait for next bar downbeat before switching
  - [x] Align incoming track's downbeat with bar onset (beat-matched)
- [x] **UI sizing improvements:**
  - [x] Smaller track pads (60Ã—60px compact layout)
  - [x] Larger control buttons (56px+ height for tablet tapping)
- [x] Duck ramp (1000ms fade)
- [x] Duck EQ (4kHz -12dB Q=1 during duck)
- [x] **Tempo lock toggle:**
  - [x] Add TEMPO button to ControlBar (ðŸ”’/ðŸ”“ icons)
  - [x] When unlocked: tracks play at native speed (default for CUT mode)
  - [x] When locked: tracks time-stretch to target BPM
- [x] **CUT mode native speed:**
  - [x] CUT mode defaults to native tempo (no time-stretching)
  - [x] Fix Tempo overrides this when enabled
- [x] **Interactive BPM display:**
  - [x] Click BPM to open text input
  - [x] Drag up/down to adjust BPM in real-time
- [x] **Queue panel (right side):**
  - [x] Vertical list on right edge showing upcoming tracks
  - [x] Now Playing highlighted at top with progress
  - [x] Tap track to remove from queue
  - [x] Track name and BPM badge display
- [x] **Auto-advance:** When track queue runs out, play next track from library
- [x] **Tempo-sorted grid layout:**
  - [x] Distribute tracks into rows by average tempo (slowest first, fastest last)
  - [x] Dynamically allocate into quintiles (lowest 20% of tempo range, then next 20%, etc.)
  - [x] Rows scroll horizontally once they exceed page width
- [x] **Liquid grid layout (no-scroll):**
  - [x] Number of tempo rows adapts to available screen height (no vertical scrolling)
  - [x] Tracks distributed evenly across however many rows fit
  - [x] Row height and button size scale to fill viewport
  - [x] Works across iPad (1024Ã—768) to desktop (2560Ã—1440) without scrolling
- [x] **Queue playback behaviour:**
  - [x] Songs in queue play out fully; last 2 bars of outgoing overlap with first 2 bars of incoming (2-bar mix)
  - [x] Single click: add track to end of queue
  - [x] Double click: insert track as next in queue
  - [x] Triple click: immediate 2-bar mix; queue resumes as normal after
  - [x] Queue resumes after any click action (queue is never cleared)
  - [x] Drag-and-drop reordering of queue items
- [x] **BUG #2 â€” forced-mix leaves queue in rapid-fire mode:**
  - [x] Root cause: `addToQueue` reset `autoAdvanceRequested`, causing auto-advance to re-fire during async track load
  - [x] Fix: `preparingQueueItem` flag prevents concurrent loads; removed reset from `addToQueue`; explicit `forceImmediateMix = false` in completeMix/executeCut
- [x] **BUG #4 â€” first track triple-stutter on initial click:**
  - [x] Root cause: same auto-advance race â€” concurrent `decodeAudioData` calls stutter the audio thread
  - [x] Fix: `preparingQueueItem` guard + 50ms fade-in on initial play masks SoundTouch startup artifacts
- [x] **Play/Pause toggle (#1 â€” merged Stop+Pause):**
  - [x] Removed Stop button (redundant with Pause; neither clears queue)
  - [x] Single Play/Pause toggle: shows Play when paused/stopped, Pause when playing
- [x] **Pause/Resume polish (Notes #1):**
  - [x] Pause: 0.5s fade-down, gates scheduler via isPausedByUser
  - [x] Resume: rewind 1s (clamped to 0), 0.5s fade-up
  - [x] Pauses both decks during mid-mix pause
- [x] **Modularity refactor:**
  - [x] Extracted QueueManager (pure data class, no audio deps)
  - [x] DualDeckEngine reorganised as orchestrator with clear section headers
  - [x] Deleted dead audioEngine.ts, removed stale types
  - [x] Comprehensive JSDoc comments across all engine files
  - [x] Manual AudioContext-timestamp position tracking (SoundTouchJS percentagePlayed fix)
- [x] **Smooth queue animation (Notes #2):**
  - [x] Fade-out opacity + height collapse on removed queue items (200ms)
  - [x] Slide-in from right for new queue items (200ms)
  - [x] Respects prefers-reduced-motion via motion-reduce: variant (WCAG AAA)
  - [x] Carbon productive-motion easing: cubic-bezier(0.2, 0, 0.38, 0.9)
- [x] **Rewind button (#6):**
  - [x] Restarts current track from beginning with 50ms fade-in
  - [x] Cancels in-progress mix if active; re-prepares queue item
  - [x] Queue preserved â€” playback continues normally after restart
- [x] **Advanced dropdown menu (#8):**
  - [x] Settings dropdown in ControlBar (gear icon + label)
  - [x] Contains: MIX/CUT toggle, Tempo Lock toggle, Clear Queue action
  - [x] Click-outside and Escape to close; proper ARIA roles
  - [x] Main bar decluttered: only Duck + transport controls visible
- [x] **Light/dark mode theming:**
  - [x] CSS custom properties for light and dark themes
  - [x] useTheme hook with localStorage persistence
  - [x] Toggle in settings dropdown (Sun/Moon icons)
  - [x] Default to light mode; WCAG AAA contrast verified
- [x] **CUT transition smoothness:**
  - [x] Replaced 50ms micro-fade with 1-beat musical fade-out
  - [x] Incoming track ramps in over 20ms (click-free)
  - [x] Brief 1-beat overlap â€” still a "cut", not a crossfade
- [x] **Duck â†’ TALK rename:**
  - [x] Renamed to TALK (clearer for session leaders speaking over music)
  - [x] Moved to transport group (left of BACK)
  - [x] Icon: Mic when off, VolumeX when active
- [x] **Mix duration setting (Notes #12 partial):**
  - [x] 1 / 2 / 4 bar toggle in settings dropdown (default: 2)
  - [x] Controls crossfade length for MIX transitions and auto-advance scheduling
- [x] **Tempo lock fixes:**
  - [x] playTrackImmediately respects fixTempo on first play
  - [x] MIX transition: no tempo slide when locked â€” both decks at locked rate
  - [x] completeMix preserves locked BPM instead of resetting to native

**Deliverable:** Simplified controls matching spec v4.

---

### Phase 5: PWA & Offline
- [x] **Service worker + offline caching:**
  - [x] Cache-first app shell (HTML, CSS, JS, icons)
  - [x] Network-first navigation (offline fallback)
  - [x] Stale-while-revalidate for other assets
  - [x] Archive.zip excluded from SW cache (too large)
  - [x] Versioned cache with automatic purge on deploy
- [x] **Install prompt / Add to Home Screen (PWA):**
  - [x] Web app manifest with name, icons, orientation, theme
  - [x] apple-mobile-web-app-capable meta tags for iOS
  - [x] SVG app icon with capoeira branding
  - [x] Standalone display, landscape orientation preferred
- [x] **Touch optimisation + large hit targets:**
  - [x] Global touch-action: manipulation (prevents double-tap zoom on iPad)
  - [x] All interactive elements â‰¥44px touch target (Carbon compliance)
  - [x] -webkit-tap-highlight-color: transparent globally
  - [x] Queue remove button enlarged from 22px to 44px
  - [x] Toast dismiss button enlarged from 32px to 44px
- [x] **Responsive layout (1024Ã—768 â†’ 2560Ã—1440):**
  - [x] Min resolution: 1024 (w) Ã— 768 (h)
  - [x] Max resolution: 2560 (w) Ã— 1440 (h)
  - [x] Graceful degradation beyond those bounds
- [ ] Tablet layout testing
- [x] **Error handling + validation feedback:**
  - [x] Toast notification system (error/success/info variants)
  - [x] Auto-dismiss with variant-specific durations (3-6s)
  - [x] User-visible error messages on track load/queue/mix failures
  - [x] ARIA role="status" + aria-live="polite" for screen readers
  - [x] IBM Carbon inline notification pattern
- [ ] **Lazy Decode + Eviction Cache (Notes #12):**
  - [ ] Store MP3 blobs in Cache API (disk) instead of decoding all at ZIP load
  - [ ] Decode on demand when track is queued (1-2s lead time)
  - [ ] Keep max 3 AudioBuffers in memory (playing + next + preload)
  - [ ] Evict old buffers after deck swap â€” enables 150 MB+ libraries on iPad 5
- [x] **Help / onboarding (Notes #2):**
  - [x] Help modal with grouped interaction instructions
  - [x] Auto-shown on first visit (localStorage flag)
  - [x] ? button in bottom-right corner to re-open
  - [x] Focus trap, Escape to close, click-outside to close (WCAG AAA)
  - [x] Quick Start workflow summary
  - [x] 48px close/dismiss buttons (Carbon touch target)
- [x] **Queue-end behaviour setting (Notes #4):**
  - [x] Setting for what happens when queue empties: stop / random / tempo-ascending / tempo-descending
  - [x] Default: next in library order. UI: 5-button toggle in settings dropdown
- [x] **Double-click queue item to delete (Notes #5):**
  - [x] Double-click on queued item triggers animated remove (same as X button)
- [x] **Default stopped state (Notes #10):**
  - [x] Verified: engine starts phase='idle', no auto-play, waits for user click
- [x] **Persist queue & play history (#7):**
  - [x] Save queue + history to localStorage (debounced, scoped per library)
  - [x] Restore queue on library load; re-queue saved items into engine
  - [x] Record play history (track name + timestamp) on each track change
  - [x] Collapsible history panel in QueuePanel (most recent first, timestamped)
  - [x] Max 200 history entries; graceful fallback if localStorage full
- [x] **Capoeira colour scheme (Notes #1):**
  - [x] Defined 20-colour palette in tailwind.config.js under `cap.*` namespace
  - [x] Neutrals: Berimbau Black â†’ Charcoal â†’ Arena Sand â†’ Cord Cotton â†’ AbadÃ¡ White
  - [x] Accents: Brazil Green, Leaf Green, Pastinha Yellow, Ocre Dourado, Flag Blue
  - [x] Warm tones: Biriba Wood, CabaÃ§a Gourd, Leather Strap, Atabaque Burgundy
  - [x] Replaced ALL Tailwind default colour classes (gray/green/amber/blue/red) across 7 files
  - [x] WCAG verified: AAA (7:1+) for all text on neutral bgs; AA (4.5:1+) on coloured surfaces
- [x] **Design audit (#3):**
  - [x] WCAG AAA contrast: bumped text-gray-500 â†’ text-gray-400, text-gray-400 â†’ text-gray-300 for 10px text
  - [x] Removed opacity-70 on TrackButton BPM text (was reducing contrast below threshold)
  - [x] Added focus-visible rings to demo library button
  - [x] Added role="alert" to error messages, improved recovery guidance (Nielsen #9)
  - [x] Added title tooltip to TrackButton explaining click interactions (Nielsen #6)
  - [x] Added two-step confirmation to Clear Queue (Nielsen #5: error prevention)
  - [x] Verified IBM Carbon: 56px min-height buttons, productive-motion easing, system-ui font
  - [x] Verified ARIA: toolbar, status, list, listitem, expanded, pressed, grabbed roles throughout

**Deliverable:** Installable, offline-capable app optimised for tablets.

---

### Phase 6: Future (v2+)
- [x] Queue panel UI (visible "Up Next" list)
- [x] Queue editing (reorder, delete, modify)
- [x] BPM click-to-type input (manual override)
- [ ] Alternative stretch engine (Rubberband WASM for desktop)
- [ ] **Presentation clicker control (#5):**
  - [ ] Map clicker buttons (next/prev/blank) to app actions
  - [ ] Clicker hardware TBD
- [x] **Play history UI (#6):**
  - [x] Collapsible history section in QueuePanel (most recent first)
  - [x] Shows track name + timestamp for each play
  - [ ] Navigate back to a previously played track (future enhancement)
- [x] **Click history items to queue (Notes #6):**
  - [x] Click a history entry to re-add that track to the end of the queue
  - [x] Toast confirmation on re-queue; error if track not found in library
- [ ] **Transport scrub bar (Notes #1):**
  - [ ] Draggable playhead bar at bottom of screen for repositioning
- [ ] **MP3 upload without beatmaps (Notes #7):**
  - [ ] Fallback mode: accept raw MP3s without beat maps
  - [ ] Use filename or metadata for tempo estimation
  - [ ] Basic tempo sorting on UI; no beat-matched mixing
- [ ] **Silence detection (Notes #9, #11):**
  - [ ] Scan first bar / 2 seconds of audio for silence
  - [ ] Subtle indicator on track button for tracks with silent intros
  - [ ] Optionally skip silence â€” locate where music starts and mix from next bar
- [ ] **Beatmap creation guide (Notes #8):**
  - [ ] Documentation: how to create beat maps with Logic Pro
  - [ ] Principles for other DAWs (Ableton, Reaper, etc.)

---

## Current Status
**Phase 5 near-complete. Remaining: tablet layout testing (manual), Lazy Decode + Eviction Cache (#12).**

## Notes Integration
All 12 items from `Notes for incorperation.md` have been incorporated:
- #1 â†’ Phase 6 (Transport scrub bar)
- #2 â†’ Phase 5 (Help / onboarding)
- #3 â†’ Phase 5 (Queue-end behaviour â€” documents auto-advance basis)
- #4 â†’ Phase 5 (Queue-end behaviour setting)
- #5 â†’ Phase 5 (Double-click queue delete)
- #6 â†’ Phase 6 (Click history to queue)
- #7 â†’ Phase 6 (MP3 without beatmaps)
- #8 â†’ Phase 6 (Beatmap creation guide)
- #9 â†’ Phase 6 (Silence detection)
- #10 â†’ Phase 5 (Default stopped state)
- #11 â†’ Phase 6 (Silence-aware mixing)
- #12 â†’ Phase 5 (Lazy Decode + Eviction Cache)
