# Marcação Mestre — Development Plan v2

## Overview
Build a PWA beat-matched grid player for Capoeira classes per Spec v4.

## Phases

### Phase 1: Core Playback (MVP)
- [x] Project setup (Vite + React + TypeScript + Tailwind)
- [x] ZIP upload + manifest parsing
- [x] MIDI tempo track parser
- [x] IndexedDB storage layer (Dexie.js)
- [x] Basic grid UI with button states
- [x] Single-track playback (no transitions)
- [x] Duck control

**Deliverable:** User can upload ZIP, see grid, tap to play one track at a time.

---

### Phase 2: Transitions
- [x] SoundTouchJS integration for time-stretching
- [x] Beat scheduler (downbeat detection)
- [x] Quantise ON mode (locked BPM transitions)
- [x] Equal-power crossfade
- [x] Transport status display (NOW/NEXT/STATUS)
- [x] Dual-deck engine architecture

**Deliverable:** Beat-matched crossfades at locked BPM.

---

### Phase 3: Tempo Slide
- [x] Quantise OFF mode (tempo slide algorithm)
- [x] Dual-deck synchronised tempo ramping
- [ ] Polish transition smoothness

**Deliverable:** Smooth tempo-sliding transitions.

---

### Phase 4: UX Polish (Spec v4 Simplification)
- [x] Fix: Audible crossfade not working (CHG-03) — fixed isPlaying condition
- [x] Track click behaviour:
  - [x] Single click: add to end of queue
  - [x] Double click: insert as next track
  - [x] Triple click: mix immediately
- [x] Multi-track queue with per-track mix settings
- [x] Drag-and-drop upload
- [x] **Simplified Controls (v4):**
  - [x] Replace Quantise + Mix Length with single MIX/CUT toggle
    - MIX = 2-bar quantised crossfade with tempo slide
    - CUT = bar-aligned instant switch with beat sync
  - [x] NEXT button to trigger queued track transition immediately
  - [x] Global Pause with fade effects:
    - Pause: 0.5s fade-down
    - Resume: rewind 1s, then 0.5s fade-up
- [x] **CUT mode enhancement:**
  - [x] Wait for next bar downbeat before switching
  - [x] Align incoming track's downbeat with bar onset (beat-matched)
- [ ] Duck ramp (1000ms fade)
- [ ] Duck EQ (4kHz -12dB Q=1 during duck)

**Deliverable:** Simplified controls matching spec v4.

---

### Phase 5: PWA & Offline
- [ ] Service worker + offline caching
- [ ] Install prompt / Add to Home Screen
- [ ] Touch optimisation + large hit targets
- [ ] Tablet layout testing
- [ ] Error handling + validation feedback

**Deliverable:** Installable, offline-capable app optimised for tablets.

---

### Phase 6: Future (v2+)
- [ ] Queue panel UI (visible "Up Next" list)
- [ ] Queue editing (reorder, delete, modify)
- [ ] BPM click-to-type input (manual override)
- [ ] Alternative stretch engine (Rubberband WASM for desktop)

---

## Current Status
**Phase 4 in progress — implementing v4 simplified controls**
