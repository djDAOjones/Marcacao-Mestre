# MarcaÃ§Ã£o Mestre â€” Development Plan v2

## Overview
Build a PWA beat-matched grid player for Capoeira classes per Spec v4.

## Phases

### Phase 1: Core Playback (MVP)
- [x] Project setup (Vite + React + TypeScript + Tailwind)
- [x] ZIP upload + manifest parsing
- [x] MIDI tempo track parser
- [x] IndexedDB storage layer (Dexie.js)
- [x] Basic grid UI with button states
- [x] Single-track playback (no transitions)
- [x] Duck control

**Deliverable:** User can upload ZIP, see grid, tap to play one track at a time.

---

### Phase 2: Transitions
- [x] SoundTouchJS integration for time-stretching
- [x] Beat scheduler (downbeat detection)
- [x] Quantise ON mode (locked BPM transitions)
- [x] Equal-power crossfade
- [x] Transport status display (NOW/NEXT/STATUS)
- [x] Dual-deck engine architecture

**Deliverable:** Beat-matched crossfades at locked BPM.

---

### Phase 3: Tempo Slide
- [x] Quantise OFF mode (tempo slide algorithm)
- [x] Dual-deck synchronised tempo ramping
- [ ] Polish transition smoothness

**Deliverable:** Smooth tempo-sliding transitions.

---

### Phase 4: UX Polish (Spec v4 Simplification)
- [x] Fix: Audible crossfade not working (CHG-03) â€” fixed isPlaying condition
- [x] Track click behaviour:
  - [x] Single click: add to end of queue
  - [x] Double click: insert as next track
  - [x] Triple click: mix immediately
- [x] Multi-track queue with per-track mix settings
- [x] Drag-and-drop upload
- [x] **Simplified Controls (v4):**
  - [x] Replace Quantise + Mix Length with single MIX/CUT toggle
    - MIX = 2-bar quantised crossfade with tempo slide
    - CUT = bar-aligned instant switch with beat sync
  - [x] NEXT button to trigger queued track transition immediately
  - [x] Global Pause with fade effects:
    - Pause: 0.5s fade-down
    - Resume: rewind 1s, then 0.5s fade-up
- [x] **CUT mode enhancement:**
  - [x] Wait for next bar downbeat before switching
  - [x] Align incoming track's downbeat with bar onset (beat-matched)
- [x] **UI sizing improvements:**
  - [x] Smaller track pads (60Ã—60px compact layout)
  - [x] Larger control buttons (56px+ height for tablet tapping)
- [x] Duck ramp (1000ms fade)
- [x] Duck EQ (4kHz -12dB Q=1 during duck)
- [x] **Tempo lock toggle:**
  - [x] Add TEMPO button to ControlBar (ðŸ”’/ðŸ”“ icons)
  - [x] When unlocked: tracks play at native speed (default for CUT mode)
  - [x] When locked: tracks time-stretch to target BPM
- [x] **CUT mode native speed:**
  - [x] CUT mode defaults to native tempo (no time-stretching)
  - [x] Fix Tempo overrides this when enabled
- [x] **Interactive BPM display:**
  - [x] Click BPM to open text input
  - [x] Drag up/down to adjust BPM in real-time
- [x] **Queue panel (right side):**
  - [x] Vertical list on right edge showing upcoming tracks
  - [x] Now Playing highlighted at top with progress
  - [x] Tap track to remove from queue
  - [x] Track name and BPM badge display
- [x] **Auto-advance:** When track queue runs out, play next track from library
- [x] **Tempo-sorted grid layout:**
  - [x] Distribute tracks into rows by average tempo (slowest first, fastest last)
  - [x] Dynamically allocate into quintiles (lowest 20% of tempo range, then next 20%, etc.)
  - [x] Rows scroll horizontally once they exceed page width
- [x] **Queue playback behaviour:**
  - [x] Songs in queue play out fully; last 2 bars of outgoing overlap with first 2 bars of incoming (2-bar mix)
  - [x] Single click: add track to end of queue
  - [x] Double click: insert track as next in queue
  - [x] Triple click: immediate 2-bar mix; queue resumes as normal after
  - [x] Queue resumes after any click action (queue is never cleared)
  - [x] Drag-and-drop reordering of queue items
- [x] **BUG #2 â€” forced-mix leaves queue in rapid-fire mode:**
  - [x] Root cause: `addToQueue` reset `autoAdvanceRequested`, causing auto-advance to re-fire during async track load
  - [x] Fix: `preparingQueueItem` flag prevents concurrent loads; removed reset from `addToQueue`; explicit `forceImmediateMix = false` in completeMix/executeCut
- [x] **BUG #4 â€” first track triple-stutter on initial click:**
  - [x] Root cause: same auto-advance race â€” concurrent `decodeAudioData` calls stutter the audio thread
  - [x] Fix: `preparingQueueItem` guard + 50ms fade-in on initial play masks SoundTouch startup artifacts
- [x] **Play/Pause toggle (#1 â€” merged Stop+Pause):**
  - [x] Removed Stop button (redundant with Pause; neither clears queue)
  - [x] Single Play/Pause toggle: shows Play when paused/stopped, Pause when playing
- [x] **Pause/Resume polish (Notes #1):**
  - [x] Pause: 0.5s fade-down, gates scheduler via isPausedByUser
  - [x] Resume: rewind 1s (clamped to 0), 0.5s fade-up
  - [x] Pauses both decks during mid-mix pause
- [x] **Modularity refactor:**
  - [x] Extracted QueueManager (pure data class, no audio deps)
  - [x] DualDeckEngine reorganised as orchestrator with clear section headers
  - [x] Deleted dead audioEngine.ts, removed stale types
  - [x] Comprehensive JSDoc comments across all engine files
  - [x] Manual AudioContext-timestamp position tracking (SoundTouchJS percentagePlayed fix)
- [x] **Smooth queue animation (Notes #2):**
  - [x] Fade-out opacity + height collapse on removed queue items (200ms)
  - [x] Slide-in from right for new queue items (200ms)
  - [x] Respects prefers-reduced-motion via motion-reduce: variant (WCAG AAA)
  - [x] Carbon productive-motion easing: cubic-bezier(0.2, 0, 0.38, 0.9)
- [x] **Rewind button (#6):**
  - [x] Restarts current track from beginning with 50ms fade-in
  - [x] Cancels in-progress mix if active; re-prepares queue item
  - [x] Queue preserved â€” playback continues normally after restart
- [x] **Advanced dropdown menu (#8):**
  - [x] Settings dropdown in ControlBar (gear icon + label)
  - [x] Contains: MIX/CUT toggle, Tempo Lock toggle, Clear Queue action
  - [x] Click-outside and Escape to close; proper ARIA roles
  - [x] Main bar decluttered: only Duck + transport controls visible

**Deliverable:** Simplified controls matching spec v4.

---

### Phase 5: PWA & Offline
- [ ] Service worker + offline caching
- [ ] Install prompt / Add to Home Screen
- [ ] Touch optimisation + large hit targets
- [x] **Responsive layout (1024Ã—768 â†’ 2560Ã—1440):**
  - [x] Min resolution: 1024 (w) Ã— 768 (h)
  - [x] Max resolution: 2560 (w) Ã— 1440 (h)
  - [x] Graceful degradation beyond those bounds
- [ ] Tablet layout testing
- [ ] Error handling + validation feedback
- [x] **Persist queue & play history (#7):**
  - [x] Save queue + history to localStorage (debounced, scoped per library)
  - [x] Restore queue on library load; re-queue saved items into engine
  - [x] Record play history (track name + timestamp) on each track change
  - [x] Collapsible history panel in QueuePanel (most recent first, timestamped)
  - [x] Max 200 history entries; graceful fallback if localStorage full
- [x] **Design audit (#3):**
  - [x] WCAG AAA contrast: bumped text-gray-500 â†’ text-gray-400, text-gray-400 â†’ text-gray-300 for 10px text
  - [x] Removed opacity-70 on TrackButton BPM text (was reducing contrast below threshold)
  - [x] Added focus-visible rings to demo library button
  - [x] Added role="alert" to error messages, improved recovery guidance (Nielsen #9)
  - [x] Added title tooltip to TrackButton explaining click interactions (Nielsen #6)
  - [x] Added two-step confirmation to Clear Queue (Nielsen #5: error prevention)
  - [x] Verified IBM Carbon: 56px min-height buttons, productive-motion easing, system-ui font
  - [x] Verified ARIA: toolbar, status, list, listitem, expanded, pressed, grabbed roles throughout

**Deliverable:** Installable, offline-capable app optimised for tablets.

---

### Phase 6: Future (v2+)
- [x] Queue panel UI (visible "Up Next" list)
- [x] Queue editing (reorder, delete, modify)
- [x] BPM click-to-type input (manual override)
- [ ] Alternative stretch engine (Rubberband WASM for desktop)
- [ ] **Presentation clicker control (#5):**
  - [ ] Map clicker buttons (next/prev/blank) to app actions
  - [ ] Clicker hardware TBD
- [x] **Play history UI (#6):**
  - [x] Collapsible history section in QueuePanel (most recent first)
  - [x] Shows track name + timestamp for each play
  - [ ] Navigate back to a previously played track (future enhancement)

---

## Current Status
**Phase 5 substantially complete. Remaining: service worker, install prompt, tablet testing.**
