# MarcaÃ§Ã£o Mestre â€” Development Plan v2

## Overview
Build a PWA beat-matched grid player for Capoeira classes per Spec v4.

## Phases

### Phase 1: Core Playback (MVP)
- [x] Project setup (Vite + React + TypeScript + Tailwind)
- [x] ZIP upload + manifest parsing
- [x] MIDI tempo track parser
- [x] IndexedDB storage layer (Dexie.js)
- [x] Basic grid UI with button states
- [x] Single-track playback (no transitions)
- [x] Duck control

**Deliverable:** User can upload ZIP, see grid, tap to play one track at a time.

---

### Phase 2: Transitions
- [x] SoundTouchJS integration for time-stretching
- [x] Beat scheduler (downbeat detection)
- [x] Quantise ON mode (locked BPM transitions)
- [x] Equal-power crossfade
- [x] Transport status display (NOW/NEXT/STATUS)
- [x] Dual-deck engine architecture

**Deliverable:** Beat-matched crossfades at locked BPM.

---

### Phase 3: Tempo Slide
- [x] Quantise OFF mode (tempo slide algorithm)
- [x] Dual-deck synchronised tempo ramping
- [ ] Polish transition smoothness

**Deliverable:** Smooth tempo-sliding transitions.

---

### Phase 4: UX Polish (Spec v4 Simplification)
- [x] Fix: Audible crossfade not working (CHG-03) â€” fixed isPlaying condition
- [x] Track click behaviour:
  - [x] Single click: add to end of queue
  - [x] Double click: insert as next track
  - [x] Triple click: mix immediately
- [x] Multi-track queue with per-track mix settings
- [x] Drag-and-drop upload
- [x] **Simplified Controls (v4):**
  - [x] Replace Quantise + Mix Length with single MIX/CUT toggle
    - MIX = 2-bar quantised crossfade with tempo slide
    - CUT = bar-aligned instant switch with beat sync
  - [x] NEXT button to trigger queued track transition immediately
  - [x] Global Pause with fade effects:
    - Pause: 0.5s fade-down
    - Resume: rewind 1s, then 0.5s fade-up
- [x] **CUT mode enhancement:**
  - [x] Wait for next bar downbeat before switching
  - [x] Align incoming track's downbeat with bar onset (beat-matched)
- [x] **UI sizing improvements:**
  - [x] Smaller track pads (60Ã—60px compact layout)
  - [x] Larger control buttons (56px+ height for tablet tapping)
- [x] Duck ramp (1000ms fade)
- [x] Duck EQ (4kHz -12dB Q=1 during duck)
- [x] **Tempo lock toggle:**
  - [x] Add TEMPO button to ControlBar (ðŸ”’/ðŸ”“ icons)
  - [x] When unlocked: tracks play at native speed (default for CUT mode)
  - [x] When locked: tracks time-stretch to target BPM
- [x] **CUT mode native speed:**
  - [x] CUT mode defaults to native tempo (no time-stretching)
  - [x] Fix Tempo overrides this when enabled
- [x] **Interactive BPM display:**
  - [x] Click BPM to open text input
  - [x] Drag up/down to adjust BPM in real-time
- [x] **Queue panel (right side):**
  - [x] Vertical list on right edge showing upcoming tracks
  - [x] Now Playing highlighted at top with progress
  - [x] Tap track to remove from queue
  - [x] Track name and BPM badge display
- [x] **Auto-advance:** When track queue runs out, play next track from library
- [x] **Tempo-sorted grid layout:**
  - [x] Distribute tracks into rows by average tempo (slowest first, fastest last)
  - [x] Dynamically allocate into quintiles (lowest 20% of tempo range, then next 20%, etc.)
  - [x] Rows scroll horizontally once they exceed page width
- [ ] **Queue playback behaviour:**
  - [ ] Songs in queue play out fully; last 2 bars of outgoing overlap with first 2 bars of incoming (2-bar mix)
  - [ ] Single click: add track to end of queue
  - [ ] Double click: insert track as next in queue
  - [ ] Triple click: immediate 2-bar mix; queue resumes as normal after
  - [ ] Queue resumes after any click action (queue is never cleared)
  - [ ] Drag-and-drop reordering of queue items

**Deliverable:** Simplified controls matching spec v4.

---

### Phase 5: PWA & Offline
- [ ] Service worker + offline caching
- [ ] Install prompt / Add to Home Screen
- [ ] Touch optimisation + large hit targets
- [ ] **Responsive layout (1024Ã—768 â†’ 2560Ã—1440):**
  - [ ] Min resolution: 1024 (w) Ã— 768 (h)
  - [ ] Max resolution: 2560 (w) Ã— 1440 (h)
  - [ ] Graceful degradation beyond those bounds
- [ ] Tablet layout testing
- [ ] Error handling + validation feedback

**Deliverable:** Installable, offline-capable app optimised for tablets.

---

### Phase 6: Future (v2+)
- [ ] Queue panel UI (visible "Up Next" list)
- [ ] Queue editing (reorder, delete, modify)
- [ ] BPM click-to-type input (manual override)
- [ ] Alternative stretch engine (Rubberband WASM for desktop)

---

## Current Status
**Phase 4 complete â€” ready for Phase 5 (PWA & Offline)**
